{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://diamond/spec/schemas/tbac.schema.json",
  "title": "tbac.batch",
  "type": "object",
  "properties": {
    "span_type": { "const": "tbac.batch" },
    "schema_version": { "$ref": "common.defs.json#/$defs/semver" },
    "period": {
      "type": "string",
      "pattern": "^[0-9]{4}-[0-9]{2}$",
      "description": "Período no formato YYYY-MM"
    },
    "shard_id": {
      "type": "integer",
      "minimum": 0,
      "description": "ID do shard (0 se não houver sharding)"
    },
    "entries": {
      "type": "array",
      "maxItems": 50000,
      "items": {
        "type": "object",
        "properties": {
          "tid": {
            "type": "string",
            "pattern": "^did:diamond:[a-f0-9]{64}\\.[a-f0-9]{64}(:v[0-9]+)?$"
          },
          "capsule_b3": { "$ref": "common.defs.json#/$defs/b3" },
          "manifest_b3": { "$ref": "common.defs.json#/$defs/b3" },
          "metrics": {
            "type": "object",
            "properties": {
              "A": { "type": "number", "minimum": 0, "maximum": 1 },
              "R": { "type": "number", "minimum": 1 },
              "C": { "type": "number", "minimum": 0, "maximum": 1 },
              "P": { "type": "number", "enum": [0, 0.5, 1] },
              "V": {
                "anyOf": [
                  { "type": "number", "minimum": 0 },
                  { "type": "null" }
                ]
              },
              "V_LB95": {
                "anyOf": [
                  { "type": "number", "minimum": 0 },
                  { "type": "null" }
                ]
              }
            },
            "required": ["A", "R", "C", "P"],
            "additionalProperties": false
          }
        },
        "required": ["tid", "capsule_b3", "manifest_b3", "metrics"],
        "additionalProperties": false
      }
    },
    "merkle": {
      "type": "object",
      "properties": {
        "algorithm": {
          "type": "string",
          "enum": ["blake2s", "sha256", "blake3"]
        },
        "root": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        },
        "tree_depth": {
          "type": "integer",
          "minimum": 1,
          "maximum": 32
        }
      },
      "required": ["algorithm", "root", "tree_depth"],
      "additionalProperties": false
    },
    "prev_root": {
      "anyOf": [
        { "type": "null" },
        {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        }
      ],
      "description": "Hash do ROOT do mês anterior (null se primeiro mês)"
    },
    "bytes_canon_hash_b3": { "$ref": "common.defs.json#/$defs/b3" },
    "signature_ed25519": { "$ref": "common.defs.json#/$defs/hex" },
    "sig_context": {
      "type": "string",
      "const": "diamond:tbac:v1"
    },
    "owner_id": { "$ref": "common.defs.json#/$defs/owner" },
    "tenant_id": { "$ref": "common.defs.json#/$defs/tenant" },
    "visibility": {
      "type": "string",
      "enum": ["private", "public"]
    }
  },
  "required": [
    "span_type",
    "schema_version",
    "period",
    "shard_id",
    "entries",
    "merkle",
    "prev_root",
    "bytes_canon_hash_b3",
    "signature_ed25519",
    "sig_context",
    "owner_id",
    "tenant_id",
    "visibility"
  ],
  "additionalProperties": false
}

